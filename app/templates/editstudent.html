{% extends "layout.html" %}
{% set curr_tab = "students" %}
{% block content1 %}
<title>Edit Student</title>
{% endblock %}
{% block content2 %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10" style="overflow: auto;">
            <h1 class="text-center" style="padding: 10px;">Edit Student</h1>
            <form method="POST" class="form-control" style="max-height: 470px; overflow:auto;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div id="student_image_container" class="form-group student_image_container">
                    <img id="student_info_image" src="{{ image_url or "https://res.cloudinary.com/dulew9heh/image/upload/v1701248545/image_nahubr.jpg" }}" alt="{{ id }}">
                </div>
                <div class="form-group  text-center">
                    <input id="image_url" type="text" name="image_url" value="{{ image_url or "https://res.cloudinary.com/dulew9heh/image/upload/v1701248545/image_nahubr.jpg" }}" hidden>
                    <input type="file" id="file-input" hidden>
                    <button id="file-button" type="button" class="btn btn-primary col-md-4 mx-auto" style="margin-top: 10px;">Upload Image</button>
                </div>
                <div class="form-group">
                    <label for="student_id">Student ID</label>
                    <input type="text" class="form-control" id="student_id" name="student_id" value="{{student_id}}" disabled required>
                    <input name="student_id" value="{{student_id}}" hidden>
                </div>
                <div class="form-group">
                    <label for="first_name">First Name</label>
                    <input type="text" class="form-control" id="first_name" name="first_name" value="{{first_name}}" required>
                </div>
                <div class="form-group">
                    <label for="last_name">Last Name</label>
                    <input type="text" class="form-control" id="last_name" name="last_name" value="{{last_name}}" required>
                </div>    
                <div class="form-group">
                    <label for="course_code">Course Code</label>
                    <select class="form-select" id="course_code" name="course_code" required>
                        <option value="{{ course_code }}" selected>{{ course_code }}</option>
                        {% for course in courses %}
                            {% if course.coursecode != course_code %}
                                <option value="{{ course.coursecode }}">{{ course.coursecode }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="year_level">Year Level</label>
                    <select class="form-select" id="year_level" name="year_level" required>
                        <option value="1" {% if year_level | string == '1' %}selected{% endif %}>1</option>
                        <option value="2" {% if year_level | string == '2' %}selected{% endif %}>2</option>
                        <option value="3" {% if year_level | string == '3' %}selected{% endif %}>3</option>
                        <option value="4" {% if year_level | string == '4' %}selected{% endif %}>4</option>
                        <option value="5" {% if year_level | string == '5' %}selected{% endif %}>5</option>
                        <option value="6" {% if year_level | string == '6' %}selected{% endif %}>6</option>
                    </select>
                </div>                
                <div class="form-group">
                    <label for="gender">Gender</label>
                    <select class="form-select" id="gender" name="gender" required>
                        <option value="Male" {% if gender == 'Male' %}selected{% endif %}>Male</option>
                        <option value="Female" {% if gender == 'Female' %}selected{% endif %}>Female</option>
                    </select>
                </div> <br>
                <button type="submit" class="btn btn-primary col-md-12">Update Student</button>
            </form>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('file-input');
    const fileButton = document.getElementById('file-button');
    const imagePreview = document.getElementById('student_info_image');
    const imageUrlInput = document.getElementById('image_url');
    const imagePreviewContainer = document.getElementById('student_image_container')
  
    fileButton.addEventListener('click', () => {
      fileInput.click();
    });
  
    fileInput.addEventListener('change', async () => {
        try {
            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("csrf_token", "{{csrf_token()}}");
        
            imagePreviewContainer.innerHTML = '<div id="student_info_image"> <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div> </div>';
    
            const response = await fetch("{{url_for('students.upload_to_cloudinary')}}", {
                method: 'POST',
                body: formData
            });
    
            const data = await response.json();

            if (data && data.is_success) {

                const img = document.createElement("img");
                img.id = 'student_info_image';
                img.alt = "New Image Photo"
                img.src = data.url

                imagePreviewContainer.innerHTML = '';
                imagePreviewContainer.appendChild(img);
                
                imageUrlInput.value = data.url;
            } else {
                // Handle the case where the upload was not successful
                console.error("Upload failed:", data);
            }
        } catch (error) {
            console.error("An error occurred:", error);
        }
    });
    
</script>
{% endblock%}
